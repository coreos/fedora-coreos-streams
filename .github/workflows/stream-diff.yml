---
name: Check stream diffs
on:
  pull_request:
    branches: [main]
    paths: ["streams/*.json"]
permissions:
  contents: read

jobs:
  stream-diff:
    name: Check stream diffs
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Genericize metadata
        run: |
          # Cache data from PR head
          mkdir head
          cp -r streams ci/genericize-stream.py head

          # Switch to base
          git checkout "${GITHUB_BASE_REF}"

          # Genericize metadata
          mkdir -p {old,new}/streams
          for stream in streams/*.json; do
              echo "${stream}, old"
              head/genericize-stream.py "${stream}" > "old/${stream}"
              echo "${stream}, new"
              head/genericize-stream.py "head/${stream}" > "new/${stream}"
          done
      - name: Compare genericized metadata
        uses: coreos/actions-lib/check-diff@main
        with:
          basedir: old
          patchdir: new
